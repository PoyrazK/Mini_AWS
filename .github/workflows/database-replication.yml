name: Database Replication Tests

on:
  push:
    branches: [main, "feature/*"]
    paths:
      - 'internal/core/services/database.go'
      - 'internal/repositories/postgres/database_repo.go'
      - 'internal/workers/database_failover_worker.go'
      - 'tests/database_replication_e2e_test.go'
      - '.github/workflows/database-replication.yml'
  pull_request:
    branches: [main]
    paths:
      - 'internal/core/services/database.go'
      - 'internal/repositories/postgres/database_repo.go'
      - 'internal/workers/database_failover_worker.go'
      - 'tests/database_replication_e2e_test.go'
      - '.github/workflows/database-replication.yml'

jobs:
  replication-test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: cloud
          POSTGRES_PASSWORD: cloud
          POSTGRES_DB: cloud
        ports:
          - 5433:5432
        options: >-
          --health-cmd "pg_isready -U cloud"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      # Mock Replica (Simulated as another Postgres instance)
      postgres-replica:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: cloud
          POSTGRES_PASSWORD: cloud
          POSTGRES_DB: cloud
        ports:
          - 5434:5432
        options: >-
          --health-cmd "pg_isready -U cloud"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v6
      
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24'
          cache: true

      - name: Install Dependencies
        run: go mod download

      - name: Wait for Database
        run: |
          until pg_isready -h localhost -p 5433 -U cloud; do
            echo "Waiting for primary postgres..."
            sleep 2
          done
          until pg_isready -h localhost -p 5434 -U cloud; do
            echo "Waiting for replica postgres..."
            sleep 2
          done

      - name: Run Database Migrations
        env:
          DATABASE_URL: postgres://cloud:cloud@localhost:5433/cloud?sslmode=disable
        run: |
          go run ./cmd/api -migrate-only

      - name: Start API Server
        env:
          DATABASE_URL: postgres://cloud:cloud@localhost:5433/cloud?sslmode=disable
          COMPUTE_BACKEND: docker
          TEST_DOCKER_NETWORK: cloud-network
        run: |
          # Start the API server in the background
          go run ./cmd/api > api.log 2>&1 &
          echo $! > api.pid
          
          # Wait for the server to be ready
          echo "Waiting for API server to start..."
          timeout 30s bash -c 'until curl -s http://localhost:8080/health/live; do sleep 1; done' || (cat api.log && exit 1)
          echo "API server started."

      - name: Run Replication E2E Tests
        env:
          DATABASE_URL: postgres://cloud:cloud@localhost:5433/cloud?sslmode=disable
          TEST_DOCKER_NETWORK: cloud-network
          # In CI, we use the service name for container-to-container comms if using docker network,
          # but here we run tests from host against exposed ports. 
          # The API normally spawns docker containers.
          # For this E2E test, we rely on the logic that spawns real docker containers.
        run: |
          # Create the network the API will use
          docker network create cloud-network || true
          
          # Run the specific replication test
          go test -v -timeout 5m -run TestDatabaseReplicationE2E ./tests/...
          
          # Cleanup
          kill $(cat api.pid)
